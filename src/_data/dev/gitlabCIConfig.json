"\n#\n#    C O D S E N\n#\n\nthy_pipeline:\n  image: node:latest\n  stage: deploy\n  script:\n    ##\n    ## Create the SSH directory and give it the right permissions\n    ##\n    - mkdir -p ~/.ssh\n    - chmod 700 ~/.ssh\n\n    ##\n    ## Install ssh-agent if not already installed, it is required by Docker.\n    ## (change apt-get to yum if you use an RPM-based image)\n    ##\n    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client git -y )'\n\n    ##\n    ## Write the private key\n    ##\n    - echo \"$SSH_PRIVATE_KEY\" | tr -d '\\r' > ~/.ssh/id_rsa\n\n    ##\n    ## Set its permissions\n    ##\n    - chmod 700 ~/.ssh/id_rsa\n\n    ##\n    ## Run ssh-agent inside the build environment\n    ##\n    - eval \"$(ssh-agent -s)\"\n\n    ##\n    ## Add the SSH key\n    ##\n    - ssh-add ~/.ssh/id_rsa\n\n    ##\n    ## Scan the keys of gitlab.com\n    ##\n    - ssh-keyscan -H 'gitlab.com' >> ~/.ssh/known_hosts\n    - chmod 644 ~/.ssh/known_hosts\n\n    ##\n    ## Start the helper to store credentials\n    ##\n    # - git config --global credential.helper store\n\n    ##\n    ## Set up git remote\n    ##\n    - git remote set-url origin git@gitlab.com:codsen/codsen.git\n\n    ##\n    ## And git credentials\n    ##\n    - git config --global user.email \"$GITLAB_USER_EMAIL\"\n    - git config --global user.name \"$YOUR_NAME_SURNAME\"\n    - echo \"git user:\"\n    - git config user.name\n\n    ##\n    ## Set up npm credentials\n    ##\n    - npm set unsafe-perm true -g\n    - npm set //registry.npmjs.org/:_authToken $NPM_TOKEN -g\n    - npm set username $NPM_USERNAME -g\n    - npm set email $NPM_EMAIL -g\n    - echo \"npm user:\"\n    - npm whoami\n\n    ##\n    ## Fail early and loudly\n    ##\n    - set -euo pipefail\n\n    ##\n    ## Checkout the repo\n    ##\n    - git status\n    - git checkout master\n\n    ##\n    ## THE REAL ACTION STARTS\n    ##\n\n    - echo '█████████████████████████████ 1/9 - bootstrap and test █████████████████████████████'\n    - git status\n    - npm run fresh\n\n    - echo '█████████████████████████████ 2/9 - readme █████████████████████████████'\n    - git status\n    - npm run readme:generate\n\n    - echo '█████████████████████████████ 3/9 - the first git add █████████████████████████████'\n    - git status\n    - git add packages\n    - git add stats\n    - git add README.md\n    - \"git add package-lock.json || echo 'no package-lock.json'\"\n    - \"git diff-index --quiet HEAD || git commit -m '[skip ci] chore: automated build tasks' --no-verify\"\n    - npm run pub:vers\n\n    - echo '█████████████████████████████ 4/9 - the last git add █████████████████████████████'\n    - git status\n    - git add packages\n    - git add README.md\n\n    - echo '█████████████████████████████ 5/9 - the last commit █████████████████████████████'\n    - git status\n    - \"git commit -m '[skip ci] chore: automated build tasks' --no-verify\"\n    - git status\n\n    - echo '█████████████████████████████ 6/9 - deploy █████████████████████████████'\n    - git status\n    - npm run republish\n\n    - echo '█████████████████████████████ 7/9 - push after deploy █████████████████████████████'\n    - git status\n    - git push origin master\n\n    - echo '█████████████████████████████ 8/9 - purge jsdelivr █████████████████████████████'\n    - \"curl https://purge.jsdelivr.net/npm/detergent/dist/detergent.umd.js || echo 'detergent unreachable on jsdelivr'\"\n    - \"curl https://purge.jsdelivr.net/npm/html-crush/dist/html-crush.umd.js || echo 'html-crush unreachable on jsdelivr'\"\n    - \"curl https://purge.jsdelivr.net/npm/email-comb/dist/email-comb.umd.js || echo 'email-comb unreachable on jsdelivr'\"\n    - \"curl https://purge.jsdelivr.net/npm/string-strip-html/dist/string-strip-html.umd.js || echo 'string-strip-html unreachable on jsdelivr'\"\n    - \"curl https://purge.jsdelivr.net/npm/emlint/dist/emlint.umd.js || echo 'emlint unreachable on jsdelivr'\"\n    - \"curl https://purge.jsdelivr.net/npm/codsen-tokenizer/dist/codsen-tokenizer.umd.js || echo 'codsen-tokenizer unreachable on jsdelivr'\"\n    - \"curl https://purge.jsdelivr.net/npm/codsen-parser/dist/codsen-parser.umd.js || echo 'codsen-parser unreachable on jsdelivr'\"\n    - \"curl https://purge.jsdelivr.net/npm/json-variables/dist/json-variables.umd.js || echo 'json-variables unreachable on jsdelivr'\"\n    - \"curl -X POST $VERCEL_TRIGGER || echo 'vercel unreachable'\"\n\n    - echo '█████████████████████████████ 9/9 - done ████████████████████████████'\n"